import{_ as a,c as s,o as t,ae as i}from"./chunks/framework.CBQY1fUt.js";const k=JSON.parse('{"title":"生命周期钩子","description":"","frontmatter":{},"headers":[],"relativePath":"zh/lifecycle-hooks/index.md","filePath":"zh/lifecycle-hooks/index.md","lastUpdated":1763853533000}'),l={name:"zh/lifecycle-hooks/index.md"};function n(c,e,p,o,r,d){return t(),s("div",null,[...e[0]||(e[0]=[i(`<h1 id="生命周期钩子" tabindex="-1">生命周期钩子 <a class="header-anchor" href="#生命周期钩子" aria-label="Permalink to &quot;生命周期钩子&quot;">​</a></h1><h2 id="在更新前后执行命令" tabindex="-1">在更新前后执行命令 <a class="header-anchor" href="#在更新前后执行命令" aria-label="Permalink to &quot;在更新前后执行命令&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>这些是使用 <code>sh</code> 执行的 shell 命令，因此需要容器内提供 <code>sh</code> 可执行文件。</p></div><blockquote><p>如果容器未在运行，则生命周期钩子无法执行，更新会在不运行任何生命周期钩子的情况下继续进行。</p></blockquote><p>可以在被 watchtower 更新的每个容器内部执行 <em>pre/post-check</em> 与 <em>pre/post-update</em> 命令。</p><ul><li><code>_pre-check</code>：在每次更新轮询之前对每个容器执行。</li><li><code>_pre-update</code>：在即将开始更新、停止容器之前执行。</li><li><code>_post-update</code>：在重启已更新的容器之后执行。</li><li><code>_post-check</code>：在每次更新轮询之后对每个容器执行。</li></ul><p>此功能默认关闭。要启用，请在命令行设置 <code>--enable-lifecycle-hooks</code>，或设置环境变量 <code>WATCHTOWER_LIFECYCLE_HOOKS=true</code>。</p><h3 id="指定更新命令" tabindex="-1">指定更新命令 <a class="header-anchor" href="#指定更新命令" aria-label="Permalink to &quot;指定更新命令&quot;">​</a></h3><p>通过 Docker 容器标签指定命令，当前可用的标签如下：</p><table tabindex="0"><thead><tr><th>类型</th><th>Docker 容器标签</th></tr></thead><tbody><tr><td>Pre Check</td><td><code>com.centurylinklabs.watchtower.lifecycle.pre-check</code></td></tr><tr><td>Pre Update</td><td><code>com.centurylinklabs.watchtower.lifecycle.pre-update</code></td></tr><tr><td>Post Update</td><td><code>com.centurylinklabs.watchtower.lifecycle.post-update</code></td></tr><tr><td>Post Check</td><td><code>com.centurylinklabs.watchtower.lifecycle.post-check</code></td></tr></tbody></table><p>这些标签可以在 Dockerfile 中作为指令声明（配合示例 .sh 文件），或作为 <code>docker run</code> 命令的一部分进行指定：</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-SBgQg" id="tab-aQw1tf0" checked><label data-title="Dockerfile" for="tab-aQw1tf0">Dockerfile</label><input type="radio" name="group-SBgQg" id="tab-htvN6R3"><label data-title="docker run" for="tab-htvN6R3">docker run</label></div><div class="blocks"><div class="language-docker vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">docker</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.centurylinklabs.watchtower.lifecycle.pre-check=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/sync.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.centurylinklabs.watchtower.lifecycle.pre-update=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/dump-data.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.centurylinklabs.watchtower.lifecycle.post-update=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/restore-data.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.centurylinklabs.watchtower.lifecycle.post-check=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/send-heartbeat.sh&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--label=com.centurylinklabs.watchtower.lifecycle.pre-check=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/sync.sh&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--label=com.centurylinklabs.watchtower.lifecycle.pre-update=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/dump-data.sh&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--label=com.centurylinklabs.watchtower.lifecycle.post-update=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/restore-data.sh&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">someimage </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">--label=com.centurylinklabs.watchtower.lifecycle.post-check=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/send-heartbeat.sh&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div></div><h3 id="超时时间" tabindex="-1">超时时间 <a class="header-anchor" href="#超时时间" aria-label="Permalink to &quot;超时时间&quot;">​</a></h3><p>所有生命周期命令的默认超时时间为 60 秒。超时后将强制继续 Watchtower 的更新循环。</p><h4 id="pre-post-update-的超时" tabindex="-1">Pre/Post-update 的超时 <a class="header-anchor" href="#pre-post-update-的超时" aria-label="Permalink to &quot;Pre/Post-update 的超时&quot;">​</a></h4><p>对于 <code>pre-update</code> 或 <code>post-update</code> 生命周期命令，可以通过添加标签 <code>com.centurylinklabs.watchtower.lifecycle.pre-update-timeout</code>（或对应的 post-update-timeout）并跟随以分钟为单位的超时值来覆盖默认超时，以允许脚本在被强制终止之前完成。</p><p>如果将标签值显式设置为 <code>0</code>，则会禁用超时。</p><h3 id="执行失败" tabindex="-1">执行失败 <a class="header-anchor" href="#执行失败" aria-label="Permalink to &quot;执行失败&quot;">​</a></h3><p>当命令执行失败，即退出码不为 0 或 75（EX_TEMPFAIL）时，不会阻止 watchtower 更新容器。只会报告一条包含退出码的错误日志。</p>`,19)])])}const u=a(l,[["render",n]]);export{k as __pageData,u as default};
